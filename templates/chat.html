{% extends "base.html" %}
{% block content %}
<section class="max-w-4xl mx-auto my-12 px-4">
  <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl shadow-xl overflow-hidden">
    <!-- Header -->
    <div class="bg-gradient-to-r from-red-600 to-red-700 p-6 text-center">
      <h2 class="text-2xl font-bold text-white flex items-center justify-center gap-2">
        <span class="bg-white bg-opacity-20 p-2 rounded-full">ðŸ’¬</span>
        Chat with CardioConsult AI
      </h2>
      <p class="text-red-100 mt-2">Your personal heart health assistant</p>
    </div>

    <!-- Chat Container -->
    <div class="p-6">
      <div id="chat-box" class="h-96 overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gradient-to-b from-gray-50 to-white mb-4">
        {% for msg in history %}
          {% if msg.role == 'user' %}
            <div class="flex justify-end mb-4">
              <div class="max-w-[80%]">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-2xl rounded-br-none">
                  {{ msg.content }}
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right">You</div>
              </div>
            </div>
          {% else %}
            <div class="flex justify-start mb-4">
              <div class="max-w-[80%]">
                <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
                  {{ msg.content }}
                </div>
                <div class="text-xs text-gray-500 mt-1">CardioConsult AI</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Input Form -->
      <form id="chat-form" class="flex space-x-2">
        <input 
          id="message" 
          name="message" 
          class="flex-1 border border-gray-300 focus:border-red-500 focus:ring-2 focus:ring-red-200 rounded-xl px-4 py-3 transition duration-200" 
          placeholder="Type your message..." 
          autocomplete="off"
        >
        <button 
          type="submit" 
          class="bg-gradient-to-r from-red-600 to-red-700 text-white px-6 py-3 rounded-xl hover:from-red-700 hover:to-red-800 shadow-md hover:shadow-lg transition duration-300 transform hover:-translate-y-0.5"
        >
          Send
        </button>
      </form>

      <!-- Clear Chat Link -->
      <div class="text-center mt-4">
        <a href="{{ url_for('clear_chat') }}" class="inline-block text-sm text-gray-600 hover:text-red-700 hover:underline transition duration-200">
          Clear Chat History
        </a>
      </div>
    </div>
  </div>
</section>

<script>
const form = document.getElementById("chat-form");
const chatBox = document.getElementById("chat-box");

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("message");
  const message = input.value.trim();
  if (!message) return;

  // Add user message to chat
  chatBox.innerHTML += `
    <div class="flex justify-end mb-4">
      <div class="max-w-[80%]">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-3 rounded-2xl rounded-br-none">
          ${message}
        </div>
        <div class="text-xs text-gray-500 mt-1 text-right">You</div>
      </div>
    </div>`;

  input.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  // Show typing indicator
  const typingIndicator = document.createElement('div');
  typingIndicator.id = 'typing-indicator';
  typingIndicator.className = 'flex justify-start mb-4';
  typingIndicator.innerHTML = `
    <div class="max-w-[80%]">
      <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
          <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
        </div>
      </div>
      <div class="text-xs text-gray-500 mt-1">CardioConsult AI</div>
    </div>`;
  chatBox.appendChild(typingIndicator);
  chatBox.scrollTop = chatBox.scrollHeight;

  try {
    const response = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message }),
    });

    // Remove typing indicator
    const typingEl = document.getElementById('typing-indicator');
    if (typingEl) typingEl.remove();

    const data = await response.json();
    if (data.reply) {
      chatBox.innerHTML += `
        <div class="flex justify-start mb-4">
          <div class="max-w-[80%]">
            <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
              ${data.reply}
            </div>
            <div class="text-xs text-gray-500 mt-1">CardioConsult AI</div>
          </div>
        </div>`;
    } else {
      chatBox.innerHTML += `
        <div class="flex justify-start text-red-500 mb-4">
          <div class="max-w-[80%]">
            <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
              Error: ${data.error || "Unable to get response."}
            </div>
            <div class="text-xs text-gray-500 mt-1">CardioConsult AI</div>
          </div>
        </div>`;
    }
  } catch (error) {
    // Remove typing indicator
    const typingEl = document.getElementById('typing-indicator');
    if (typingEl) typingEl.remove();

    chatBox.innerHTML += `
      <div class="flex justify-start text-red-500 mb-4">
        <div class="max-w-[80%]">
          <div class="bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800 px-4 py-3 rounded-2xl rounded-bl-none">
            Network error. Please try again.
          </div>
          <div class="text-xs text-gray-500 mt-1">CardioConsult AI</div>
        </div>
      </div>`;
  }

  chatBox.scrollTop = chatBox.scrollHeight;
});
</script>
{% endblock %}